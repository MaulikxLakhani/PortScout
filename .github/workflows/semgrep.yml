name: Semgrep

on:
  push:
    branches:
      - main
      - master
    paths:
      - '**/*.py'    # Include Python files if your repo has Python code
      - '.github/workflows/semgrep.yml'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  semgrep:
    name: semgrep/ci
    runs-on: ubuntu-latest
    env:
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Fetch all history for all tags and branches
      run: git fetch --prune --unshallow

    - name: Install Semgrep
      run: pip install semgrep

    - name: Get base branch ref
      id: vars
      run: echo "::set-output name=BASE_REF::$(echo ${{ github.event.pull_request.base.sha }} || echo origin/main)"

    - name: Run Semgrep
      run: semgrep --config auto --diff ${{ steps.vars.outputs.BASE_REF }} $(git rev-parse HEAD)
